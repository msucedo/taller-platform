<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Cotizaciones - Llantera</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .cotizaciones-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .cotizaciones-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .cotizaciones-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .cotizaciones-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .cotizacion-card {
            border-bottom: 1px solid #eee;
            padding: 20px;
            transition: background-color 0.2s;
        }

        .cotizacion-card:hover {
            background-color: #f8f9fa;
        }

        .cotizacion-card:last-child {
            border-bottom: none;
        }

        .cotizacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cotizacion-numero {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .cotizacion-estado {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .estado-borrador { background: #e3f2fd; color: #1976d2; }
        .estado-pendiente { background: #fff3e0; color: #f57c00; }
        .estado-aprobada { background: #e8f5e8; color: #388e3c; }
        .estado-rechazada { background: #ffebee; color: #d32f2f; }
        .estado-expirada { background: #f3e5f5; color: #7b1fa2; }

        .cotizacion-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .cotizacion-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-cotizacion {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-cotizacion.hidden {
            display: none !important;
        }

        .modal-content-cotizacion {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
        }

        .form-step {
            margin-bottom: 30px;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .items-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .totales-section {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .total-final {
            font-size: 1.3rem;
            font-weight: bold;
            border-top: 2px solid var(--primary-color);
            padding-top: 10px;
        }

        .btn-add-item {
            background: var(--color-success) !important;
            color: white !important;
        }

        .btn-remove-item {
            background: var(--color-danger) !important;
            color: white !important;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .btn-close:hover {
            background: rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            .cotizaciones-header {
                flex-direction: column;
                align-items: stretch;
            }

            .cotizacion-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .table-controls {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .item-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="cotizaciones-container">
        <div class="cotizaciones-header">
            <h1>üìã Gesti√≥n de Cotizaciones</h1>
            <div class="header-actions">
                <button onclick="nuevaCotizacion()" class="btn btn-primary">+ Nueva Cotizaci√≥n</button>
                <button onclick="volverAlDashboard()" class="btn btn-secondary">‚Üê Volver al Dashboard</button>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="cotizaciones-stats">
            <div class="stat-card">
                <span class="stat-number" id="totalCotizaciones">0</span>
                <span class="stat-label">Total Cotizaciones</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="cotizacionesPendientes">0</span>
                <span class="stat-label">Pendientes</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="cotizacionesAprobadas">0</span>
                <span class="stat-label">Aprobadas</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="valorTotal">$0</span>
                <span class="stat-label">Valor Total Aprobado</span>
            </div>
        </div>

        <!-- Tabla de cotizaciones -->
        <div class="cotizaciones-table">
            <div class="table-header">
                <h2>Lista de Cotizaciones</h2>
                <button onclick="loadCotizaciones()" class="btn btn-light btn-sm">üîÑ Actualizar</button>
            </div>
            
            <div class="table-controls" style="padding: 0 20px; padding-top: 20px;">
                <input type="text" id="buscadorCotizaciones" placeholder="Buscar por cliente, n√∫mero o t√≠tulo..." class="search-input">
                <select id="filtroEstado">
                    <option value="">Todos los estados</option>
                    <option value="borrador">Borrador</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="aprobada">Aprobada</option>
                    <option value="rechazada">Rechazada</option>
                    <option value="expirada">Expirada</option>
                </select>
                <button onclick="limpiarFiltros()" class="btn btn-secondary btn-sm">Limpiar</button>
            </div>

            <div id="cotizacionesContainer">
                <div style="padding: 40px; text-align: center; color: #666;">
                    Cargando cotizaciones...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva/Editar Cotizaci√≥n -->
    <div id="modalCotizacion" class="modal-cotizacion hidden" style="display: none;">
        <div class="modal-content-cotizacion">
            <div class="modal-header">
                <h3 id="modalTitle">Nueva Cotizaci√≥n</h3>
                <button onclick="cerrarModalCotizacion()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="cotizacionForm">
                    <input type="hidden" id="cotizacionId">
                    
                    <!-- Paso 1: Informaci√≥n del Cliente -->
                    <div class="form-step">
                        <div class="step-title">1. Informaci√≥n del Cliente</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="clienteNombre">Nombre del Cliente *</label>
                                <input type="text" id="clienteNombre" required>
                            </div>
                            <div class="form-group">
                                <label for="clienteEmail">Email *</label>
                                <input type="email" id="clienteEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="clienteTelefono">Tel√©fono</label>
                                <input type="tel" id="clienteTelefono">
                            </div>
                            <div class="form-group">
                                <label for="clienteEmpresa">Empresa</label>
                                <input type="text" id="clienteEmpresa">
                            </div>
                        </div>
                    </div>

                    <!-- Paso 2: Detalles de la Cotizaci√≥n -->
                    <div class="form-step">
                        <div class="step-title">2. Detalles de la Cotizaci√≥n</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="cotizacionTitulo">T√≠tulo *</label>
                                <input type="text" id="cotizacionTitulo" required placeholder="Ej: Llantas para Toyota Corolla 2020">
                            </div>
                            <div class="form-group">
                                <label for="validezDias">V√°lida por (d√≠as)</label>
                                <input type="number" id="validezDias" value="30" min="1" max="365">
                            </div>
                            <div class="form-group form-group-full">
                                <label for="cotizacionDescripcion">Descripci√≥n</label>
                                <textarea id="cotizacionDescripcion" rows="3" placeholder="Descripci√≥n detallada de los productos/servicios..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Items -->
                    <div class="form-step">
                        <div class="step-title">
                            3. Items de la Cotizaci√≥n
                            <button type="button" onclick="agregarItem()" class="btn btn-success btn-sm btn-add-item" style="float: right;">+ Agregar Item</button>
                        </div>
                        <div class="items-section">
                            <div class="item-row" style="font-weight: bold; background: #dee2e6;">
                                <div>Descripci√≥n</div>
                                <div>Cantidad</div>
                                <div>Precio Unit.</div>
                                <div>Desc. %</div>
                                <div>Subtotal</div>
                                <div>Acciones</div>
                            </div>
                            <div id="itemsContainer">
                                <!-- Los items se agregan din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Paso 4: Totales y Configuraci√≥n -->
                    <div class="form-step">
                        <div class="step-title">4. Totales y Configuraci√≥n</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="descuentoGeneral">Descuento General (%)</label>
                                <input type="number" id="descuentoGeneral" value="0" min="0" max="100" step="0.01" onchange="calcularTotales()">
                            </div>
                            <div class="form-group">
                                <label for="impuestoPorcentaje">Impuesto (%)</label>
                                <input type="number" id="impuestoPorcentaje" value="16" min="0" max="100" step="0.01" onchange="calcularTotales()">
                            </div>
                        </div>
                        <div class="form-group form-group-full">
                            <label for="terminosCondiciones">T√©rminos y Condiciones</label>
                            <textarea id="terminosCondiciones" rows="3" placeholder="Los precios incluyen IVA. Cotizaci√≥n v√°lida por 30 d√≠as. Se requiere 50% de anticipo."></textarea>
                        </div>
                        <div class="form-group form-group-full">
                            <label for="notasInternas">Notas Internas (no se muestran al cliente)</label>
                            <textarea id="notasInternas" rows="2" placeholder="Notas internas para el equipo..."></textarea>
                        </div>
                        
                        <div class="totales-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotalMostrar">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Descuento:</span>
                                <span id="descuentoMostrar">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Impuesto:</span>
                                <span id="impuestoMostrar">$0.00</span>
                            </div>
                            <div class="total-row total-final">
                                <span>TOTAL:</span>
                                <span id="totalMostrar">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-success">üíæ Guardar Cotizaci√≥n</button>
                        <button type="button" onclick="cerrarModalCotizacion()" class="btn btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="message" class="message hidden"></div>
    
    <!-- Modal de Confirmaci√≥n para Enviar -->
    <div id="modalEnviarConfirm" class="modal-cotizacion hidden">
        <div class="modal-content-cotizacion" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üìß Enviar Cotizaci√≥n</h3>
                <button onclick="cerrarModalEnviar()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <p id="enviarTexto">¬øEst√° seguro de que desea enviar esta cotizaci√≥n por email al cliente?</p>
                <p><small><strong>Nota:</strong> Esto cambiar√° el estado de la cotizaci√≥n a "Pendiente".</small></p>
            </div>
            <div class="form-actions">
                <button id="btnConfirmarEnvio" class="btn btn-primary">üìß Enviar</button>
                <button onclick="cerrarModalEnviar()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Aprobar -->
    <div id="modalAprobarConfirm" class="modal-cotizacion hidden">
        <div class="modal-content-cotizacion" style="max-width: 600px;">
            <div class="modal-header">
                <h3>‚úÖ Aprobar Cotizaci√≥n</h3>
                <button onclick="cerrarModalAprobar()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro de que desea aprobar esta cotizaci√≥n?</p>
                <div class="form-group">
                    <label for="comentarioAprobacion">Comentario (opcional):</label>
                    <textarea id="comentarioAprobacion" rows="3" placeholder="Agregar un comentario sobre la aprobaci√≥n..."></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button id="btnConfirmarAprobacion" class="btn btn-success">‚úÖ Aprobar</button>
                <button onclick="cerrarModalAprobar()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Rechazar -->
    <div id="modalRechazarConfirm" class="modal-cotizacion hidden">
        <div class="modal-content-cotizacion" style="max-width: 600px;">
            <div class="modal-header">
                <h3>‚ùå Rechazar Cotizaci√≥n</h3>
                <button onclick="cerrarModalRechazar()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro de que desea rechazar esta cotizaci√≥n?</p>
                <div class="form-group">
                    <label for="comentarioRechazo">Motivo del rechazo:</label>
                    <textarea id="comentarioRechazo" rows="3" placeholder="Indique el motivo del rechazo..." required></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button id="btnConfirmarRechazo" class="btn btn-danger">‚ùå Rechazar</button>
                <button onclick="cerrarModalRechazar()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    </div>

    <script src="/js/utils.js"></script>
    <script src="/js/cotizaciones.js"></script>
</body>
</html>