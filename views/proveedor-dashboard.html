<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard - Portal Proveedor</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Portal Proveedor</h1>
            <p id="welcomeMessage">Bienvenido</p>
        </header>

        <main>
            <div class="proveedor-dashboard">
                <div class="dashboard-header">
                    <h2>📋 Mi Portal</h2>
                    <div class="dashboard-actions">
                        <button onclick="cerrarSesion()" class="btn btn-secondary">Cerrar Sesión</button>
                    </div>
                </div>

                <!-- Navegación por tabs -->
                <div class="proveedor-tabs">
                    <button class="tab-btn active" onclick="showTab('solicitudes')">📋 Solicitudes</button>
                    <button class="tab-btn" onclick="showTab('cotizaciones')">💰 Cotizaciones</button>
                </div>

                <!-- Tab Solicitudes -->
                <div id="tab-solicitudes" class="tab-content active">
                    <div class="tab-actions">
                        <button onclick="abrirModalSolicitud()" class="btn btn-primary">+ Nueva Solicitud</button>
                    </div>

                    <div class="estadisticas">
                        <div class="stat-card">
                            <span class="stat-number" id="totalSolicitudes">0</span>
                            <span class="stat-label">Total Solicitudes</span>
                        </div>
                        <div class="stat-card pendiente">
                            <span class="stat-number" id="pendientesCount">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                        <div class="stat-card en_proceso">
                            <span class="stat-number" id="procesoCount">0</span>
                            <span class="stat-label">En Proceso</span>
                        </div>
                        <div class="stat-card completado">
                            <span class="stat-number" id="completadoCount">0</span>
                            <span class="stat-label">Completadas</span>
                        </div>
                    </div>

                    <div class="filtros-proveedor">
                        <select id="filtroEstado">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_proceso">En Proceso</option>
                            <option value="completado">Completado</option>
                            <option value="rechazado">Rechazado</option>
                        </select>
                        <select id="filtroServicio">
                            <option value="">Todos los servicios</option>
                            <option value="repuestos">Repuestos</option>
                            <option value="herramientas">Herramientas</option>
                            <option value="pintura">Pintura</option>
                            <option value="grua">Grúa/Remolque</option>
                            <option value="mecanico">Mecánicos</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>

                    <div id="solicitudesContainer">
                        <div class="loading">Cargando solicitudes...</div>
                    </div>
                </div>

                <!-- Tab Cotizaciones -->
                <div id="tab-cotizaciones" class="tab-content">
                    <div class="tab-actions">
                        <button onclick="abrirModalCotizacion()" class="btn btn-primary">+ Nueva Cotización</button>
                    </div>

                    <div class="estadisticas">
                        <div class="stat-card">
                            <span class="stat-number" id="totalCotizaciones">0</span>
                            <span class="stat-label">Total Cotizaciones</span>
                        </div>
                        <div class="stat-card pendiente">
                            <span class="stat-number" id="cotizacionesPendientes">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                        <div class="stat-card en_proceso">
                            <span class="stat-number" id="cotizacionesAprobadas">0</span>
                            <span class="stat-label">Aprobadas</span>
                        </div>
                        <div class="stat-card completado">
                            <span class="stat-number" id="valorTotal">$0</span>
                            <span class="stat-label">Valor Total</span>
                        </div>
                    </div>

                    <div class="filtros-proveedor">
                        <select id="filtroCotizacionEstado">
                            <option value="">Todos los estados</option>
                            <option value="borrador">Borrador</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="aprobada">Aprobada</option>
                            <option value="rechazada">Rechazada</option>
                            <option value="expirada">Expirada</option>
                        </select>
                    </div>

                    <div id="cotizacionesContainer">
                        <div class="loading">Cargando cotizaciones...</div>
                    </div>
                </div>
            </div>

            <div id="message" class="message hidden"></div>
        </main>

        <!-- Modal Nueva Cotización -->
        <div id="modalCotizacion" class="modal-overlay hidden">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 id="modalTitle">Nueva Cotización</h2>
                    <button type="button" class="modal-close" onclick="cerrarModalCotizacion()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="wizard-container">
                        <!-- Indicador de progreso -->
                        <div class="progress-indicator">
                            <div class="step active" data-step="1">
                                <span class="step-number">1</span>
                                <span class="step-title">Información del Cliente</span>
                            </div>
                            <div class="step" data-step="2">
                                <span class="step-number">2</span>
                                <span class="step-title">Detalles de la Cotización</span>
                            </div>
                            <div class="step" data-step="3">
                                <span class="step-number">3</span>
                                <span class="step-title">Items y Precios</span>
                            </div>
                            <div class="step" data-step="4">
                                <span class="step-number">4</span>
                                <span class="step-title">Totales y Confirmación</span>
                            </div>
                        </div>

                        <form id="cotizacionForm" class="cotizacion-form">
                            <input type="hidden" id="cotizacionId">
                            
                            <!-- Paso 1: Información del Cliente -->
                            <div class="step-content active" data-step="1">
                                <h3>Información del Cliente</h3>
                                <p class="step-description">Datos del cliente para quien realizará la cotización</p>
                                
                                <div class="form-group">
                                    <label for="clienteNombre">Nombre del Cliente *</label>
                                    <input type="text" id="clienteNombre" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="clienteEmail">Email *</label>
                                    <input type="email" id="clienteEmail" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="clienteTelefono">Teléfono</label>
                                    <input type="tel" id="clienteTelefono" placeholder="Ej: 3001234567">
                                </div>
                                
                                <div class="form-group">
                                    <label for="clienteEmpresa">Empresa (Opcional)</label>
                                    <input type="text" id="clienteEmpresa" placeholder="Nombre de la empresa del cliente">
                                </div>
                            </div>

                            <!-- Paso 2: Detalles de la Cotización -->
                            <div class="step-content" data-step="2">
                                <h3>Detalles de la Cotización</h3>
                                <p class="step-description">Información general de la cotización</p>
                                
                                <div class="form-group">
                                    <label for="cotizacionTitulo">Título de la Cotización *</label>
                                    <input type="text" id="cotizacionTitulo" required placeholder="Ej: Llantas para Toyota Corolla 2020">
                                </div>
                                
                                <div class="form-group">
                                    <label for="cotizacionDescripcion">Descripción</label>
                                    <textarea id="cotizacionDescripcion" rows="4" placeholder="Descripción detallada de los productos/servicios cotizados..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="validezDias">Válida por (días)</label>
                                    <input type="number" id="validezDias" value="30" min="1" max="365">
                                </div>
                                
                                <div class="form-group">
                                    <label for="terminosCondiciones">Términos y Condiciones</label>
                                    <textarea id="terminosCondiciones" rows="3" placeholder="Los precios incluyen IVA. Cotización válida por 30 días. Se requiere 50% de anticipo."></textarea>
                                </div>
                            </div>

                            <!-- Paso 3: Items -->
                            <div class="step-content" data-step="3">
                                <h3>Items y Precios</h3>
                                <p class="step-description">Agregue los productos o servicios a cotizar</p>
                                
                                <div class="items-actions">
                                    <button type="button" onclick="agregarItem()" class="btn btn-success btn-sm">+ Agregar Item</button>
                                </div>
                                
                                <div class="items-section">
                                    <div class="item-row" style="font-weight: bold; background: #dee2e6;">
                                        <div>Descripción</div>
                                        <div>Cantidad</div>
                                        <div>Precio Unit.</div>
                                        <div>Desc. %</div>
                                        <div>Subtotal</div>
                                        <div>Acciones</div>
                                    </div>
                                    <div id="itemsContainer">
                                        <!-- Los items se agregan dinámicamente -->
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 4: Totales y Configuración -->
                            <div class="step-content" data-step="4">
                                <h3>Totales y Confirmación</h3>
                                <p class="step-description">Revise los totales y configure opciones adicionales</p>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="descuentoGeneral">Descuento General (%)</label>
                                        <input type="number" id="descuentoGeneral" value="0" min="0" max="100" step="0.01" onchange="calcularTotales()">
                                    </div>
                                    <div class="form-group">
                                        <label for="impuestoPorcentaje">Impuesto (%)</label>
                                        <input type="number" id="impuestoPorcentaje" value="16" min="0" max="100" step="0.01" onchange="calcularTotales()">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="notasInternas">Notas Internas</label>
                                    <textarea id="notasInternas" rows="2" placeholder="Notas para uso interno (no visibles para el cliente)..."></textarea>
                                </div>
                                
                                <div class="totales-section">
                                    <div class="total-row">
                                        <span>Subtotal:</span>
                                        <span id="subtotalMostrar">$0.00</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Descuento General:</span>
                                        <span id="descuentoMostrar">$0.00</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Impuesto:</span>
                                        <span id="impuestoMostrar">$0.00</span>
                                    </div>
                                    <div class="total-row total-final">
                                        <span>TOTAL:</span>
                                        <span id="totalMostrar">$0.00</span>
                                    </div>
                                </div>

                                <!-- Resumen de la cotización -->
                                <div class="summary-section">
                                    <h4>Resumen de la cotización:</h4>
                                    <div id="cotizacion-summary-content"></div>
                                </div>
                            </div>

                            <!-- Botones de navegación -->
                            <div class="wizard-navigation">
                                <button type="button" id="cotizacionPrevBtn" class="btn btn-secondary" style="display: none;">Anterior</button>
                                <button type="button" id="cotizacionNextBtn" class="btn btn-primary">Siguiente</button>
                                <button type="submit" id="cotizacionSubmitBtn" class="btn btn-success btn-block" style="display: none;">💾 Crear Cotización</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <!-- Footer generado automáticamente -->
        </footer>
    </div>

    <script src="/js/utils.js"></script>
    <script src="/js/solicitud-modal.js"></script>
    <script>
        // Inicializar footer unificado
        document.addEventListener('DOMContentLoaded', function() {
            renderFooter({ type: 'simple' });
            
            // Inicializar modal de solicitud
            initSolicitudModal();
            
            // Event listeners para cotizaciones
            const cotizacionForm = document.getElementById('cotizacionForm');
            if (cotizacionForm) {
                cotizacionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarCotizacion();
                });
            }
            
            // Event listeners para navegación del wizard de cotización
            const nextBtn = document.getElementById('cotizacionNextBtn');
            const prevBtn = document.getElementById('cotizacionPrevBtn');
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (validateCotizacionCurrentStep()) {
                        if (currentCotizacionStep < totalCotizacionSteps) {
                            currentCotizacionStep++;
                            updateCotizacionWizard();
                        }
                    }
                });
            }
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentCotizacionStep > 1) {
                        currentCotizacionStep--;
                        updateCotizacionWizard();
                    }
                });
            }
            
            // Cerrar modal con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModalCotizacion();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            const modalCotizacion = document.getElementById('modalCotizacion');
            if (modalCotizacion) {
                modalCotizacion.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cerrarModalCotizacion();
                    }
                });
            }
            
            // Limpiar errores cuando el usuario empiece a escribir
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('field-error')) {
                    e.target.classList.remove('field-error');
                    const errorMsg = e.target.parentNode.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.style.display = 'none';
                    }
                }
            });
        });
    </script>
    <script>
        let solicitudes = [];
        let solicitudesFiltradas = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay datos de OAuth en URL
            procesarAutenticacionOAuth();
            
            verificarAutenticacion();
            
            const filtroEstado = document.getElementById('filtroEstado');
            const filtroServicio = document.getElementById('filtroServicio');
            
            filtroEstado.addEventListener('change', filtrarSolicitudes);
            filtroServicio.addEventListener('change', filtrarSolicitudes);
        });
        
        // Funcionalidad de tabs
        function showTab(tabName) {
            // Remover clase active de todos los botones de tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Ocultar todos los contenidos de tab
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activar el tab seleccionado
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Cargar datos del tab si es necesario
            if (tabName === 'cotizaciones') {
                cargarCotizaciones();
            }
        }
        
        function procesarAutenticacionOAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const proveedorData = urlParams.get('proveedor');
            const isNew = urlParams.get('new');
            
            if (token && proveedorData) {
                try {
                    // Guardar datos de sesión
                    localStorage.setItem('proveedorToken', token);
                    localStorage.setItem('proveedorData', proveedorData);
                    
                    // También en sessionStorage para compatibilidad
                    sessionStorage.setItem('proveedorData', proveedorData);
                    
                    // Mostrar mensaje de bienvenida
                    if (isNew) {
                        showMessage('¡Cuenta creada exitosamente! Bienvenido.', 'success');
                    } else {
                        showMessage('Inicio de sesión exitoso.', 'success');
                    }
                    
                    // Limpiar URL sin recargar la página
                    window.history.replaceState({}, document.title, '/proveedor/dashboard');
                    
                } catch (error) {
                    console.error('Error procesando autenticación:', error);
                    showMessage('Error al procesar la autenticación', 'error');
                }
            }
        }
        
        function showMessage(text, type) {
            // Crear elemento de mensaje temporal si no existe
            let messageDiv = document.getElementById('message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'message';
                messageDiv.className = 'message';
                document.querySelector('.container').appendChild(messageDiv);
            }
            
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        async function verificarAutenticacion() {
            // Verificar primero autenticación OAuth
            const oauthToken = localStorage.getItem('proveedorToken');
            const oauthData = localStorage.getItem('proveedorData');
            
            if (oauthToken && oauthData) {
                try {
                    const proveedorInfo = JSON.parse(oauthData);
                    document.getElementById('welcomeMessage').textContent = `Bienvenido, ${proveedorInfo.nombre}`;
                    
                    // Cargar solicitudes usando el token OAuth
                    await cargarSolicitudesOAuth(oauthToken);
                    return;
                } catch (error) {
                    console.error('Error con autenticación OAuth:', error);
                    // Continuar con autenticación básica
                }
            }
            
            // Autenticación básica (por email)
            const proveedorData = sessionStorage.getItem('proveedorData');
            
            if (!proveedorData) {
                window.location.href = '/proveedor';
                return;
            }
            
            const data = JSON.parse(proveedorData);
            document.getElementById('welcomeMessage').textContent = `Bienvenido, ${data.nombre}`;
            
            solicitudes = data.solicitudes;
            solicitudesFiltradas = solicitudes;
            
            mostrarEstadisticas();
            mostrarSolicitudes(solicitudes);
        }
        
        async function cargarSolicitudesOAuth(token) {
            try {
                const response = await fetch('/api/proveedor/solicitudes', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    solicitudes = data.solicitudes || [];
                    solicitudesFiltradas = solicitudes;
                    
                    mostrarEstadisticas();
                    mostrarSolicitudes(solicitudes);
                } else if (response.status === 401) {
                    // Token expirado o inválido
                    localStorage.removeItem('proveedorToken');
                    localStorage.removeItem('proveedorData');
                    window.location.href = '/proveedor';
                } else {
                    showMessage('Error al cargar las solicitudes', 'error');
                }
            } catch (error) {
                console.error('Error cargando solicitudes OAuth:', error);
                showMessage('Error de conexión al cargar solicitudes', 'error');
            }
        }
        
        function mostrarEstadisticas() {
            const total = solicitudes.length;
            const pendientes = solicitudes.filter(s => s.estado === 'pendiente').length;
            const proceso = solicitudes.filter(s => s.estado === 'en_proceso').length;
            const completado = solicitudes.filter(s => s.estado === 'completado').length;
            
            document.getElementById('totalSolicitudes').textContent = total;
            document.getElementById('pendientesCount').textContent = pendientes;
            document.getElementById('procesoCount').textContent = proceso;
            document.getElementById('completadoCount').textContent = completado;
        }
        
        function mostrarSolicitudes(solicitudesList) {
            const container = document.getElementById('solicitudesContainer');
            
            if (solicitudesList.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>No hay solicitudes</h3>
                        <p>Aún no has enviado solicitudes a la llantera.</p>
                        <button onclick="abrirModalSolicitud()" class="btn btn-primary">Crear Primera Solicitud</button>
                    </div>
                `;
                return;
            }
            
            const html = solicitudesList.map(solicitud => `
                <div class="card card-${solicitud.estado}">
                    <div class="card-header">
                        <div class="solicitud-info">
                            <h3 class="card-title">${solicitud.tipo_servicio}</h3>
                            <span class="card-subtitle">📋 ${solicitud.tracker_code}</span>
                        </div>
                        <span class="badge badge-${solicitud.estado}">
                            ${getEstadoIcon(solicitud.estado)} ${solicitud.estado.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <div class="solicitud-meta">
                            <span><strong>Urgencia:</strong> ${solicitud.urgencia}</span>
                            <span><strong>Fecha:</strong> ${formatDate(solicitud.fecha_solicitud)}</span>
                            ${solicitud.fecha_preferida ? `<span><strong>Fecha Preferida:</strong> ${formatDate(solicitud.fecha_preferida)}</span>` : ''}
                        </div>
                        
                        <div class="descripcion">
                            <strong>Descripción:</strong>
                            <p>${solicitud.descripcion}</p>
                        </div>
                        
                        ${solicitud.notas_taller ? `
                        <div class="notas-taller">
                            <strong>📝 Respuesta de la Llantera:</strong>
                            <p>${solicitud.notas_taller}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="card-actions">
                        <button onclick="verDetalle('${solicitud.tracker_code}')" class="btn btn-primary btn-sm">
                            Ver Detalle Completo
                        </button>
                        ${solicitud.estado === 'pendiente' ? `
                        <small class="help-text">💡 Puedes hacer seguimiento con el código ${solicitud.tracker_code}</small>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function filtrarSolicitudes() {
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroServicio = document.getElementById('filtroServicio').value;
            
            solicitudesFiltradas = solicitudes;
            
            if (filtroEstado) {
                solicitudesFiltradas = solicitudesFiltradas.filter(s => s.estado === filtroEstado);
            }
            
            if (filtroServicio) {
                solicitudesFiltradas = solicitudesFiltradas.filter(s => s.tipo_servicio === filtroServicio);
            }
            
            mostrarSolicitudes(solicitudesFiltradas);
        }
        
        function getEstadoIcon(estado) {
            const icons = {
                'pendiente': '⏳',
                'en_proceso': '🔧',
                'completado': '✅',
                'rechazado': '❌'
            };
            return icons[estado] || '📄';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }
        
        function verDetalle(trackerCode) {
            window.open(`/tracker?code=${trackerCode}`, '_blank');
        }
        
        function cerrarSesion() {
            // Limpiar todos los datos de sesión
            sessionStorage.removeItem('proveedorData');
            localStorage.removeItem('proveedorToken');
            localStorage.removeItem('proveedorData');
            window.location.href = '/proveedor';
        }
        
        // Funciones para cotizaciones
        let cotizaciones = [];
        let itemCounter = 0;
        
        // Variables para el wizard de cotización
        let currentCotizacionStep = 1;
        let totalCotizacionSteps = 4;
        
        function abrirModalCotizacion() {
            document.getElementById('modalTitle').textContent = 'Nueva Cotización';
            document.getElementById('cotizacionForm').reset();
            document.getElementById('cotizacionId').value = '';
            
            // Resetear wizard
            currentCotizacionStep = 1;
            updateCotizacionWizard();
            
            // Pre-llenar datos del proveedor para el cliente (fix 1)
            precargarDatosProveedor();
            
            // Limpiar items y agregar uno por defecto
            document.getElementById('itemsContainer').innerHTML = '';
            itemCounter = 0;
            
            const modal = document.getElementById('modalCotizacion');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
        
        function precargarDatosProveedor() {
            // Obtener datos del proveedor de la sesión
            const proveedorData = localStorage.getItem('proveedorData');
            if (proveedorData) {
                try {
                    const data = JSON.parse(proveedorData);
                    // Pre-llenar nombre y email del cliente con datos del proveedor
                    const nombreField = document.getElementById('clienteNombre');
                    const emailField = document.getElementById('clienteEmail');
                    
                    if (nombreField && data.nombre) {
                        nombreField.value = data.nombre;
                    }
                    
                    if (emailField && data.email) {
                        emailField.value = data.email;
                    }
                } catch (error) {
                    console.error('Error parsing proveedor data:', error);
                }
            }
        }
        
        function updateCotizacionWizard() {
            // Actualizar indicadores de paso
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.toggle('active', stepNum === currentCotizacionStep);
                step.classList.toggle('completed', stepNum < currentCotizacionStep);
            });
            
            // Mostrar/ocultar contenido de pasos
            document.querySelectorAll('.step-content').forEach(content => {
                const stepNum = parseInt(content.dataset.step);
                content.classList.toggle('active', stepNum === currentCotizacionStep);
            });
            
            // Actualizar botones
            const prevBtn = document.getElementById('cotizacionPrevBtn');
            const nextBtn = document.getElementById('cotizacionNextBtn');
            const submitBtn = document.getElementById('cotizacionSubmitBtn');
            
            prevBtn.style.display = currentCotizacionStep > 1 ? 'inline-block' : 'none';
            nextBtn.style.display = currentCotizacionStep < totalCotizacionSteps ? 'inline-block' : 'none';
            submitBtn.style.display = currentCotizacionStep === totalCotizacionSteps ? 'block' : 'none';
            
            // Si estamos en el paso 3, agregar un item por defecto si no hay ninguno
            if (currentCotizacionStep === 3 && document.querySelectorAll('#itemsContainer .item-row').length === 0) {
                agregarItem();
            }
            
            // Si estamos en el paso final, actualizar resumen
            if (currentCotizacionStep === 4) {
                updateCotizacionSummary();
                calcularTotales();
            }
        }
        
        function validateCotizacionCurrentStep() {
            // Limpiar errores previos
            clearFieldErrors();
            
            switch (currentCotizacionStep) {
                case 1:
                    const nombre = document.getElementById('clienteNombre').value.trim();
                    const email = document.getElementById('clienteEmail').value.trim();
                    let hasError = false;
                    
                    if (!nombre) {
                        showFieldError('clienteNombre', 'El nombre del cliente es requerido');
                        hasError = true;
                    }
                    
                    if (!email) {
                        showFieldError('clienteEmail', 'El email del cliente es requerido');
                        hasError = true;
                    } else if (!email.includes('@') || !email.includes('.')) {
                        showFieldError('clienteEmail', 'Por favor ingrese un email válido');
                        hasError = true;
                    }
                    
                    if (hasError) {
                        showMessage('Por favor complete los campos requeridos', 'error');
                        return false;
                    }
                    return true;
                    
                case 2:
                    const titulo = document.getElementById('cotizacionTitulo').value.trim();
                    if (!titulo) {
                        showFieldError('cotizacionTitulo', 'El título de la cotización es requerido');
                        showMessage('Por favor complete los campos requeridos', 'error');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const items = document.querySelectorAll('#itemsContainer .item-row');
                    if (items.length === 0) {
                        showMessage('Debe agregar al menos un item a la cotización', 'error');
                        return false;
                    }
                    
                    // Validar que todos los items tengan nombre y precio
                    let validItems = true;
                    let itemErrors = [];
                    
                    items.forEach((item, index) => {
                        const nombre = item.querySelector('.item-nombre')?.value?.trim();
                        const precio = item.querySelector('.item-precio')?.value;
                        
                        if (!nombre) {
                            validItems = false;
                            itemErrors.push(`Item ${index + 1}: Falta el nombre del producto/servicio`);
                        }
                        
                        if (!precio || parseFloat(precio) <= 0) {
                            validItems = false;
                            itemErrors.push(`Item ${index + 1}: Falta el precio o es inválido`);
                        }
                    });
                    
                    if (!validItems) {
                        const errorMsg = itemErrors.length > 0 ? itemErrors.join('\n') : 'Todos los items deben tener nombre y precio válido';
                        showMessage(errorMsg, 'error');
                        return false;
                    }
                    return true;
                    
                case 4:
                    return true;
                    
                default:
                    return true;
            }
        }
        
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Agregar clase de error al campo
            field.classList.add('field-error');
            
            // Crear o actualizar mensaje de error
            let errorDiv = field.parentNode.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                field.parentNode.appendChild(errorDiv);
            }
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function clearFieldErrors() {
            // Limpiar todas las clases de error y mensajes
            document.querySelectorAll('.field-error').forEach(field => {
                field.classList.remove('field-error');
            });
            
            document.querySelectorAll('.error-message').forEach(error => {
                error.style.display = 'none';
            });
        }
        
        function updateCotizacionSummary() {
            const summaryDiv = document.getElementById('cotizacion-summary-content');
            const cliente = document.getElementById('clienteNombre').value;
            const email = document.getElementById('clienteEmail').value;
            const titulo = document.getElementById('cotizacionTitulo').value;
            const items = document.querySelectorAll('#itemsContainer .item-row').length;
            
            summaryDiv.innerHTML = `
                <div class="summary-item"><strong>Cliente:</strong> ${cliente} (${email})</div>
                <div class="summary-item"><strong>Título:</strong> ${titulo}</div>
                <div class="summary-item"><strong>Items:</strong> ${items} productos/servicios</div>
                <div class="summary-item"><strong>Validez:</strong> ${document.getElementById('validezDias').value} días</div>
            `;
        }
        
        function cerrarModalCotizacion() {
            const modal = document.getElementById('modalCotizacion');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            
            // Resetear wizard
            currentCotizacionStep = 1;
            updateCotizacionWizard();
        }
        
        function agregarItem(itemData = null) {
            itemCounter++;
            const itemId = `item-${itemCounter}`;
            
            const itemHtml = `
                <div class="item-row" id="${itemId}">
                    <div>
                        <input type="text" class="item-nombre" placeholder="Nombre del producto/servicio" 
                               value="${itemData?.nombre || ''}" onchange="calcularTotales()" required>
                        <input type="text" class="item-descripcion" placeholder="Descripción detallada" 
                               value="${itemData?.descripcion || ''}" style="margin-top: 5px;">
                    </div>
                    <div>
                        <input type="number" class="item-cantidad" min="1" step="1" 
                               value="${itemData?.cantidad || 1}" onchange="calcularTotales()" required>
                    </div>
                    <div>
                        <input type="number" class="item-precio" min="0" step="0.01" 
                               value="${itemData?.precio_unitario || 0}" onchange="calcularTotales()" required>
                    </div>
                    <div>
                        <input type="number" class="item-descuento" min="0" max="100" step="0.01" 
                               value="${itemData?.descuento_porcentaje || 0}" onchange="calcularTotales()">
                    </div>
                    <div>
                        <span class="item-subtotal">$0.00</span>
                    </div>
                    <div>
                        <button type="button" onclick="eliminarItem('${itemId}')" class="btn btn-danger btn-sm btn-remove-item">×</button>
                    </div>
                </div>
            `;
            
            document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', itemHtml);
            
            // Usar setTimeout para asegurar que el DOM se actualice antes de calcular
            setTimeout(() => {
                calcularTotales();
            }, 0);
        }
        
        function eliminarItem(itemId) {
            const itemToRemove = document.getElementById(itemId);
            const itemsContainer = document.getElementById('itemsContainer');
            
            // Contar items reales (sin incluir el header)
            const actualItems = itemsContainer.querySelectorAll('.item-row');
            
            if (actualItems.length > 1) {
                if (itemToRemove) {
                    itemToRemove.remove();
                    calcularTotales();
                }
            } else {
                showMessage('Debe tener al menos un item', 'warning');
            }
        }
        
        function calcularTotales() {
            // Verificar que los elementos existan antes de hacer cálculos
            const descuentoGeneralEl = document.getElementById('descuentoGeneral');
            const impuestoPorcentajeEl = document.getElementById('impuestoPorcentaje');
            const subtotalMostrarEl = document.getElementById('subtotalMostrar');
            const descuentoMostrarEl = document.getElementById('descuentoMostrar');
            const impuestoMostrarEl = document.getElementById('impuestoMostrar');
            const totalMostrarEl = document.getElementById('totalMostrar');
            
            // Si los elementos no existen, salir sin error
            if (!descuentoGeneralEl || !impuestoPorcentajeEl || !subtotalMostrarEl) {
                return;
            }
            
            const items = document.querySelectorAll('#itemsContainer .item-row');
            let subtotal = 0;
            
            items.forEach(item => {
                const cantidadEl = item.querySelector('.item-cantidad');
                const precioEl = item.querySelector('.item-precio');
                const descuentoEl = item.querySelector('.item-descuento');
                const subtotalEl = item.querySelector('.item-subtotal');
                
                // Verificar que los elementos existan
                if (!cantidadEl || !precioEl || !descuentoEl || !subtotalEl) {
                    return;
                }
                
                const cantidad = parseFloat(cantidadEl.value) || 0;
                const precio = parseFloat(precioEl.value) || 0;
                const descuento = parseFloat(descuentoEl.value) || 0;
                
                const subtotalItem = cantidad * precio;
                const descuentoItem = subtotalItem * (descuento / 100);
                const totalItem = subtotalItem - descuentoItem;
                
                subtotalEl.textContent = `$${totalItem.toFixed(2)}`;
                subtotal += totalItem;
            });
            
            const descuentoGeneral = parseFloat(descuentoGeneralEl.value) || 0;
            const impuestoPorcentaje = parseFloat(impuestoPorcentajeEl.value) || 0;
            
            const descuentoTotal = subtotal * (descuentoGeneral / 100);
            const subtotalConDescuento = subtotal - descuentoTotal;
            const impuesto = subtotalConDescuento * (impuestoPorcentaje / 100);
            const total = subtotalConDescuento + impuesto;
            
            if (subtotalMostrarEl) subtotalMostrarEl.textContent = `$${subtotal.toFixed(2)}`;
            if (descuentoMostrarEl) descuentoMostrarEl.textContent = `$${descuentoTotal.toFixed(2)}`;
            if (impuestoMostrarEl) impuestoMostrarEl.textContent = `$${impuesto.toFixed(2)}`;
            if (totalMostrarEl) totalMostrarEl.textContent = `$${total.toFixed(2)}`;
        }
        
        async function guardarCotizacion() {
            console.log('Guardando cotización...');
            try {
                // Recopilar datos del formulario
                const cotizacionData = {
                    cliente_nombre: document.getElementById('clienteNombre').value,
                    cliente_email: document.getElementById('clienteEmail').value,
                    cliente_telefono: document.getElementById('clienteTelefono').value,
                    cliente_empresa: document.getElementById('clienteEmpresa').value,
                    titulo: document.getElementById('cotizacionTitulo').value,
                    descripcion: document.getElementById('cotizacionDescripcion').value,
                    validez_dias: document.getElementById('validezDias').value,
                    descuento_general: document.getElementById('descuentoGeneral').value,
                    impuesto_porcentaje: document.getElementById('impuestoPorcentaje').value,
                    terminos_condiciones: document.getElementById('terminosCondiciones').value,
                    notas_internas: document.getElementById('notasInternas').value
                };
                
                // Recopilar items
                const items = [];
                document.querySelectorAll('#itemsContainer .item-row').forEach(row => {
                    const item = {
                        nombre: row.querySelector('.item-nombre').value,
                        descripcion: row.querySelector('.item-descripcion').value,
                        cantidad: parseFloat(row.querySelector('.item-cantidad').value) || 0,
                        precio_unitario: parseFloat(row.querySelector('.item-precio').value) || 0,
                        descuento_porcentaje: parseFloat(row.querySelector('.item-descuento').value) || 0
                    };
                    if (item.nombre.trim()) {
                        items.push(item);
                    }
                });
                
                cotizacionData.items = items;
                console.log('Datos de cotización:', cotizacionData);
                
                // Enviar a la API
                const token = localStorage.getItem('proveedorToken');
                if (!token) {
                    showMessage('Sesión expirada, por favor inicia sesión nuevamente', 'error');
                    return;
                }
                
                console.log('Enviando petición al servidor...');
                const response = await fetch('/api/proveedor/cotizaciones', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(cotizacionData)
                });
                
                console.log('Respuesta recibida:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`Cotización creada exitosamente (${result.numero})`, 'success');
                    cerrarModalCotizacion();
                    cargarCotizaciones();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error al guardar la cotización', 'error');
                }
                
            } catch (error) {
                console.error('Error guardando cotización:', error);
                showMessage('Error de conexión al guardar la cotización', 'error');
            }
        }
        
        async function cargarCotizaciones() {
            try {
                const token = localStorage.getItem('proveedorToken');
                if (!token) {
                    return;
                }
                
                const response = await fetch('/api/proveedor/cotizaciones', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    cotizaciones = await response.json();
                    mostrarCotizaciones(cotizaciones);
                    cargarEstadisticasCotizaciones();
                } else {
                    console.error('Error al cargar cotizaciones');
                    const container = document.getElementById('cotizacionesContainer');
                    container.innerHTML = `
                        <div class="no-data">
                            <h3>Error al cargar cotizaciones</h3>
                            <p>No se pudieron cargar las cotizaciones.</p>
                            <button onclick="cargarCotizaciones()" class="btn btn-secondary">Reintentar</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                const container = document.getElementById('cotizacionesContainer');
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Error de conexión</h3>
                        <p>No se pudo conectar con el servidor.</p>
                        <button onclick="cargarCotizaciones()" class="btn btn-secondary">Reintentar</button>
                    </div>
                `;
            }
        }
        
        function mostrarCotizaciones(cotizacionesList) {
            const container = document.getElementById('cotizacionesContainer');
            
            if (cotizacionesList.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>No hay cotizaciones</h3>
                        <p>Aún no has creado cotizaciones.</p>
                        <button onclick="abrirModalCotizacion()" class="btn btn-primary">Crear Primera Cotización</button>
                    </div>
                `;
                return;
            }
            
            const html = cotizacionesList.map(cotizacion => `
                <div class="card card-${cotizacion.estado}">
                    <div class="card-header">
                        <div class="solicitud-info">
                            <h3 class="card-title">${cotizacion.titulo}</h3>
                            <span class="card-subtitle">💰 ${cotizacion.numero}</span>
                        </div>
                        <span class="badge badge-${cotizacion.estado}">
                            ${getEstadoCotizacionIcon(cotizacion.estado)} ${cotizacion.estado.toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <div class="solicitud-meta">
                            <span><strong>Cliente:</strong> ${cotizacion.cliente_nombre}</span>
                            <span><strong>Email:</strong> ${cotizacion.cliente_email}</span>
                            <span><strong>Total:</strong> $${parseFloat(cotizacion.total || 0).toFixed(2)}</span>
                            <span><strong>Fecha:</strong> ${formatDate(cotizacion.fecha_creacion)}</span>
                        </div>
                        
                        ${cotizacion.descripcion ? `
                        <div class="descripcion">
                            <strong>Descripción:</strong>
                            <p>${cotizacion.descripcion}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="card-actions">
                        <button onclick="verDetalleCotizacion('${cotizacion.id}')" class="btn btn-primary btn-sm">
                            Ver Detalle
                        </button>
                        ${cotizacion.estado === 'borrador' ? `
                        <button onclick="editarCotizacion('${cotizacion.id}')" class="btn btn-warning btn-sm">
                            Editar
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        async function cargarEstadisticasCotizaciones() {
            try {
                const token = localStorage.getItem('proveedorToken');
                if (!token) {
                    return;
                }
                
                const response = await fetch('/api/proveedor/cotizaciones/estadisticas', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalCotizaciones').textContent = stats.total || 0;
                    document.getElementById('cotizacionesPendientes').textContent = stats.pendientes || 0;
                    document.getElementById('cotizacionesAprobadas').textContent = stats.aprobadas || 0;
                    document.getElementById('valorTotal').textContent = `$${parseFloat(stats.valor_total || 0).toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
                document.getElementById('totalCotizaciones').textContent = '0';
                document.getElementById('cotizacionesPendientes').textContent = '0';
                document.getElementById('cotizacionesAprobadas').textContent = '0';
                document.getElementById('valorTotal').textContent = '$0';
            }
        }
        
        function getEstadoCotizacionIcon(estado) {
            const icons = {
                'borrador': '📝',
                'pendiente': '⏳',
                'aprobada': '✅',
                'rechazada': '❌',
                'expirada': '⏰'
            };
            return icons[estado] || '📄';
        }
        
        function verDetalleCotizacion(cotizacionId) {
            // Por ahora mostrar un mensaje
            showMessage('Funcionalidad de detalle de cotización en desarrollo', 'info');
        }
        
        function editarCotizacion(cotizacionId) {
            // Por ahora mostrar un mensaje
            showMessage('Funcionalidad de editar cotización en desarrollo', 'info');
        }
        
        // Auto-llenar código en tracker si viene de URL
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                verDetalle(code);
            }
        });
    </script>
</body>
</html>