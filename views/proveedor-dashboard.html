<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard - Portal Proveedor</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Portal Proveedor</h1>
            <p id="welcomeMessage">Bienvenido</p>
        </header>

        <main>
            <div class="proveedor-dashboard">
                <div class="dashboard-header">
                    <h2>📋 Mis Solicitudes</h2>
                    <div class="dashboard-actions">
                        <a href="/" class="btn btn-primary">+ Nueva Solicitud</a>
                        <button onclick="cerrarSesion()" class="btn btn-secondary">Cerrar Sesión</button>
                    </div>
                </div>

                <div class="estadisticas">
                    <div class="stat-card">
                        <span class="stat-number" id="totalSolicitudes">0</span>
                        <span class="stat-label">Total Solicitudes</span>
                    </div>
                    <div class="stat-card pendiente">
                        <span class="stat-number" id="pendientesCount">0</span>
                        <span class="stat-label">Pendientes</span>
                    </div>
                    <div class="stat-card en_proceso">
                        <span class="stat-number" id="procesoCount">0</span>
                        <span class="stat-label">En Proceso</span>
                    </div>
                    <div class="stat-card completado">
                        <span class="stat-number" id="completadoCount">0</span>
                        <span class="stat-label">Completadas</span>
                    </div>
                </div>

                <div class="filtros-proveedor">
                    <select id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="en_proceso">En Proceso</option>
                        <option value="completado">Completado</option>
                        <option value="rechazado">Rechazado</option>
                    </select>
                    <select id="filtroServicio">
                        <option value="">Todos los servicios</option>
                        <option value="repuestos">Repuestos</option>
                        <option value="herramientas">Herramientas</option>
                        <option value="pintura">Pintura</option>
                        <option value="grua">Grúa/Remolque</option>
                        <option value="mecanico">Mecánicos</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>

                <div id="solicitudesContainer">
                    <div class="loading">Cargando solicitudes...</div>
                </div>
            </div>

            <div id="message" class="message hidden"></div>
        </main>

        <footer>
            <!-- Footer generado automáticamente -->
        </footer>
    </div>

    <script src="/js/utils.js"></script>
    <script>
        // Inicializar footer unificado
        document.addEventListener('DOMContentLoaded', function() {
            renderFooter({ type: 'simple' });
        });
    </script>
    <script>
        let solicitudes = [];
        let solicitudesFiltradas = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay datos de OAuth en URL
            procesarAutenticacionOAuth();
            
            verificarAutenticacion();
            
            const filtroEstado = document.getElementById('filtroEstado');
            const filtroServicio = document.getElementById('filtroServicio');
            
            filtroEstado.addEventListener('change', filtrarSolicitudes);
            filtroServicio.addEventListener('change', filtrarSolicitudes);
        });
        
        function procesarAutenticacionOAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const proveedorData = urlParams.get('proveedor');
            const isNew = urlParams.get('new');
            
            if (token && proveedorData) {
                try {
                    // Guardar datos de sesión
                    localStorage.setItem('proveedorToken', token);
                    localStorage.setItem('proveedorData', proveedorData);
                    
                    // También en sessionStorage para compatibilidad
                    sessionStorage.setItem('proveedorData', proveedorData);
                    
                    // Mostrar mensaje de bienvenida
                    if (isNew) {
                        showMessage('¡Cuenta creada exitosamente! Bienvenido.', 'success');
                    } else {
                        showMessage('Inicio de sesión exitoso.', 'success');
                    }
                    
                    // Limpiar URL sin recargar la página
                    window.history.replaceState({}, document.title, '/proveedor/dashboard');
                    
                } catch (error) {
                    console.error('Error procesando autenticación:', error);
                    showMessage('Error al procesar la autenticación', 'error');
                }
            }
        }
        
        function showMessage(text, type) {
            // Crear elemento de mensaje temporal si no existe
            let messageDiv = document.getElementById('message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'message';
                messageDiv.className = 'message';
                document.querySelector('.container').appendChild(messageDiv);
            }
            
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        async function verificarAutenticacion() {
            // Verificar primero autenticación OAuth
            const oauthToken = localStorage.getItem('proveedorToken');
            const oauthData = localStorage.getItem('proveedorData');
            
            if (oauthToken && oauthData) {
                try {
                    const proveedorInfo = JSON.parse(oauthData);
                    document.getElementById('welcomeMessage').textContent = `Bienvenido, ${proveedorInfo.nombre}`;
                    
                    // Cargar solicitudes usando el token OAuth
                    await cargarSolicitudesOAuth(oauthToken);
                    return;
                } catch (error) {
                    console.error('Error con autenticación OAuth:', error);
                    // Continuar con autenticación básica
                }
            }
            
            // Autenticación básica (por email)
            const proveedorData = sessionStorage.getItem('proveedorData');
            
            if (!proveedorData) {
                window.location.href = '/proveedor';
                return;
            }
            
            const data = JSON.parse(proveedorData);
            document.getElementById('welcomeMessage').textContent = `Bienvenido, ${data.nombre}`;
            
            solicitudes = data.solicitudes;
            solicitudesFiltradas = solicitudes;
            
            mostrarEstadisticas();
            mostrarSolicitudes(solicitudes);
        }
        
        async function cargarSolicitudesOAuth(token) {
            try {
                const response = await fetch('/api/proveedor/solicitudes', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    solicitudes = data.solicitudes || [];
                    solicitudesFiltradas = solicitudes;
                    
                    mostrarEstadisticas();
                    mostrarSolicitudes(solicitudes);
                } else if (response.status === 401) {
                    // Token expirado o inválido
                    localStorage.removeItem('proveedorToken');
                    localStorage.removeItem('proveedorData');
                    window.location.href = '/proveedor';
                } else {
                    showMessage('Error al cargar las solicitudes', 'error');
                }
            } catch (error) {
                console.error('Error cargando solicitudes OAuth:', error);
                showMessage('Error de conexión al cargar solicitudes', 'error');
            }
        }
        
        function mostrarEstadisticas() {
            const total = solicitudes.length;
            const pendientes = solicitudes.filter(s => s.estado === 'pendiente').length;
            const proceso = solicitudes.filter(s => s.estado === 'en_proceso').length;
            const completado = solicitudes.filter(s => s.estado === 'completado').length;
            
            document.getElementById('totalSolicitudes').textContent = total;
            document.getElementById('pendientesCount').textContent = pendientes;
            document.getElementById('procesoCount').textContent = proceso;
            document.getElementById('completadoCount').textContent = completado;
        }
        
        function mostrarSolicitudes(solicitudesList) {
            const container = document.getElementById('solicitudesContainer');
            
            if (solicitudesList.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>No hay solicitudes</h3>
                        <p>Aún no has enviado solicitudes a la llantera.</p>
                        <a href="/" class="btn btn-primary">Crear Primera Solicitud</a>
                    </div>
                `;
                return;
            }
            
            const html = solicitudesList.map(solicitud => `
                <div class="card card-${solicitud.estado}">
                    <div class="card-header">
                        <div class="solicitud-info">
                            <h3 class="card-title">${solicitud.tipo_servicio}</h3>
                            <span class="card-subtitle">📋 ${solicitud.tracker_code}</span>
                        </div>
                        <span class="badge badge-${solicitud.estado}">
                            ${getEstadoIcon(solicitud.estado)} ${solicitud.estado.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <div class="solicitud-meta">
                            <span><strong>Urgencia:</strong> ${solicitud.urgencia}</span>
                            <span><strong>Fecha:</strong> ${formatDate(solicitud.fecha_solicitud)}</span>
                            ${solicitud.fecha_preferida ? `<span><strong>Fecha Preferida:</strong> ${formatDate(solicitud.fecha_preferida)}</span>` : ''}
                        </div>
                        
                        <div class="descripcion">
                            <strong>Descripción:</strong>
                            <p>${solicitud.descripcion}</p>
                        </div>
                        
                        ${solicitud.notas_taller ? `
                        <div class="notas-taller">
                            <strong>📝 Respuesta de la Llantera:</strong>
                            <p>${solicitud.notas_taller}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="card-actions">
                        <button onclick="verDetalle('${solicitud.tracker_code}')" class="btn btn-primary btn-sm">
                            Ver Detalle Completo
                        </button>
                        ${solicitud.estado === 'pendiente' ? `
                        <small class="help-text">💡 Puedes hacer seguimiento con el código ${solicitud.tracker_code}</small>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function filtrarSolicitudes() {
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroServicio = document.getElementById('filtroServicio').value;
            
            solicitudesFiltradas = solicitudes;
            
            if (filtroEstado) {
                solicitudesFiltradas = solicitudesFiltradas.filter(s => s.estado === filtroEstado);
            }
            
            if (filtroServicio) {
                solicitudesFiltradas = solicitudesFiltradas.filter(s => s.tipo_servicio === filtroServicio);
            }
            
            mostrarSolicitudes(solicitudesFiltradas);
        }
        
        function getEstadoIcon(estado) {
            const icons = {
                'pendiente': '⏳',
                'en_proceso': '🔧',
                'completado': '✅',
                'rechazado': '❌'
            };
            return icons[estado] || '📄';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }
        
        function verDetalle(trackerCode) {
            window.open(`/tracker?code=${trackerCode}`, '_blank');
        }
        
        function cerrarSesion() {
            // Limpiar todos los datos de sesión
            sessionStorage.removeItem('proveedorData');
            localStorage.removeItem('proveedorToken');
            localStorage.removeItem('proveedorData');
            window.location.href = '/proveedor';
        }
        
        // Auto-llenar código en tracker si viene de URL
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                verDetalle(code);
            }
        });
    </script>
</body>
</html>